<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>追蹤球員與球隊</title>
<style>
    body {
        font-family: "Arial", sans-serif;
        background-color: #f4f4f9;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        padding-top: 40px;
    }

    .container {
        background: #ffffff;
        width: 1000px;
        padding: 35px 40px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    h1 {
        text-align: center;
        margin-bottom: 25px;
        color: #333;
    }

    h2 {
        margin-top: 25px;
        color: #333;
        border-bottom: 1px solid #ccc;
        padding-bottom: 5px;
        cursor: pointer;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
    }

    th, td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: center;
    }

    th {
        background-color: #f0f0f0;
    }

    .section {
        margin-bottom: 20px;
        background-color: #f9f9f9;
        padding: 12px 15px;
        border-radius: 8px;
        border: 1px solid #ddd;
    }

    .hidden {
        display: none;
    }

    .switch-buttons {
        margin-bottom: 20px;
        text-align: center;
    }

    .btn {
        padding: 10px 15px;
        border: none;
        border-radius: 6px;
        font-size: 15px;
        cursor: pointer;
        margin-right: 10px;
        color: white;
        background-color: #007bff;
        transition: background 0.2s;
    }

    .btn:hover {
        background-color: #0056b3;
    }

    .search-area {
        margin: 10px 0 20px 0;
        text-align: center;
    }

    .search-area input[type="text"] {
        padding: 6px;
        width: 250px;
        border-radius: 4px;
        border: 1px solid #ccc;
    }

    .search-area button {
        padding: 6px 12px;
        margin-left: 6px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        background-color: #28a745;
        color: white;
        transition: background 0.2s;
    }

    .search-area button:hover {
        background-color: #1e7e34;
    }

    .follow-btn {
        padding: 4px 8px;
        cursor: pointer;
        border-radius: 4px;
        border: none;
        background-color: #17a2b8;
        color: white;
        transition: background 0.2s;
    }

    .follow-btn:hover {
        background-color: #117a8b;
    }

    .info-text {
        color: #555;
        font-size: 0.9rem;
        margin-bottom: 10px;
    }

</style>
</head>
<body>
<div class="container">
    <h1>追蹤球員與球隊</h1>

    <div class="switch-buttons">
        <button class="btn" onclick="showTab('player')">追蹤球員</button>
        <button class="btn" onclick="showTab('team')">追蹤球隊</button>
        <button class="btn" onclick="location.href='dashboard.html'">回主畫面</button>
    </div>

    <!-- 球員分頁 -->
    <div id="player-tab">
        <div class="section">
            <h2 onclick="toggleSection('followed-players-section')">已追蹤球員列表 ▼</h2>
            <div id="followed-players-section">
                <p class="info-text">以下為目前帳號追蹤中的球員。</p>
                <table>
                    <thead>
                        <tr>
                            <th>球員 ID</th>
                            <th>姓名</th>
                            <th>背號</th>
                            <th>所屬球隊</th>
                            <th>追蹤時間</th>
                            <th>資訊</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="followed-players-body"></tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h2 onclick="toggleSection('player-recent-section')">球員最近十場比賽 ▼</h2>
            <div id="player-recent-section">
                <p class="info-text">點擊「查看」後，會在下方顯示該球員最近 10 場比賽結果。</p>
                <table>
                    <thead>
                        <tr>
                            <th>比賽 ID</th>
                            <th>日期</th>
                            <th>場地</th>
                            <th>主隊</th>
                            <th>客隊</th>
                            <th>比數</th>
                        </tr>
                    </thead>
                    <tbody id="player-recent-body">
                        <tr><td colspan="6">尚未選擇球員</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h2 onclick="toggleSection('search-player-section')">查詢球員並追蹤 ▼</h2>
            <div id="search-player-section">
                <div class="search-area">
                    <input type="text" id="player-search-input" placeholder="輸入球員姓名關鍵字" />
                    <button onclick="searchPlayers()">查詢</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>球員 ID</th>
                            <th>姓名</th>
                            <th>背號</th>
                            <th>狀態</th>
                            <th>所屬球隊</th>
                            <th>聯盟</th>
                            <th>追蹤</th>
                        </tr>
                    </thead>
                    <tbody id="search-players-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 球隊分頁 -->
    <div id="team-tab" class="hidden">
        <div class="section">
            <h2 onclick="toggleSection('followed-teams-section')">已追蹤球隊列表 ▼</h2>
            <div id="followed-teams-section">
                <p class="info-text">以下為目前帳號追蹤中的球隊。</p>
                <table>
                    <thead>
                        <tr>
                            <th>球隊 ID</th>
                            <th>球隊名稱</th>
                            <th>總教練</th>
                            <th>追蹤時間</th>
                            <th>資訊</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="followed-teams-body"></tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h2 onclick="toggleSection('team-recent-section')">球隊最近十場比賽 ▼</h2>
            <div id="team-recent-section">
                <p class="info-text">點擊「查看」後，會在下方顯示該球隊最近 10 場比賽結果。</p>
                <table>
                    <thead>
                        <tr>
                            <th>比賽 ID</th>
                            <th>日期</th>
                            <th>場地</th>
                            <th>主隊</th>
                            <th>客隊</th>
                            <th>比數</th>
                        </tr>
                    </thead>
                    <tbody id="team-recent-body">
                        <tr><td colspan="6">尚未選擇球隊</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h2 onclick="toggleSection('search-team-section')">查詢球隊並追蹤 ▼</h2>
            <div id="search-team-section">
                <div class="search-area">
                    <input type="text" id="team-search-input" placeholder="輸入球隊名稱關鍵字" />
                    <button onclick="searchTeams()">查詢</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>球隊 ID</th>
                            <th>球隊名稱</th>
                            <th>總教練</th>
                            <th>聯盟</th>
                            <th>追蹤</th>
                        </tr>
                    </thead>
                    <tbody id="search-teams-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

    <script>
      const BASE_URL = "http://127.0.0.1:5000";
      const currentUserId = localStorage.getItem("user_id");

      if (!currentUserId) {
        alert("請先登入，再使用追蹤功能");
        window.location.href = "login.html";
      }

      // 展開/收起區塊
      function toggleSection(id) {
        const section = document.getElementById(id);
        section.classList.toggle("hidden");
      }

      // 切換分頁
      function showTab(type) {
        const playerTab = document.getElementById("player-tab");
        const teamTab = document.getElementById("team-tab");

        if (type === "player") {
          playerTab.classList.remove("hidden");
          teamTab.classList.add("hidden");
          loadFollowedPlayers();
        } else {
          playerTab.classList.add("hidden");
          teamTab.classList.remove("hidden");
          loadFollowedTeams();
        }
      }

      // ======================== 球員 ========================
      async function searchPlayers() {
        const name = document
          .getElementById("player-search-input")
          .value.trim();
        const tbody = document.getElementById("search-players-body");
        tbody.innerHTML = "";

        if (!name) {
          tbody.innerHTML = `<tr><td colspan="7">請輸入球員姓名</td></tr>`;
          return;
        }

        try {
          const res = await fetch(`${BASE_URL}/follow/search_players`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name }),
          });

          const data = await res.json();

          if (!data.success) {
            tbody.innerHTML = `<tr><td colspan="7">${
              data.error || "查詢失敗"
            }</td></tr>`;
            return;
          }

          if (data.result.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7">查無資料</td></tr>`;
            return;
          }

          data.result.forEach((p) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${p.player_id}</td>
                <td>${p.player_name}</td>
                <td>${p.number ?? ""}</td>
                <td>${p.status}</td>
                <td>${p.team_name}</td>
                <td>${p.league_name}</td>
                <td>
                    <button class="follow-btn" onclick="followPlayer(${
                      p.player_id
                    })">追蹤</button>
                </td>
            `;
            tbody.appendChild(tr);
          });
        } catch (err) {
          console.error(err);
          tbody.innerHTML = `<tr><td colspan="7">系統錯誤：${err}</td></tr>`;
        }
      }

      async function followPlayer(playerId) {
        try {
          const res = await fetch(`${BASE_URL}/follow/player`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              player_id: playerId,
              user_id: currentUserId,
            }),
          });
          const data = await res.json();
          alert(data.message || (data.success ? "成功追蹤球員" : "追蹤失敗"));
          if (data.success) loadFollowedPlayers();
        } catch (err) {
          console.error(err);
          alert("追蹤失敗，請稍後再試");
        }
      }

      async function loadFollowedPlayers() {
        const tbody = document.getElementById("followed-players-body");
        tbody.innerHTML = "";
        try {
          const res = await fetch(
            `${BASE_URL}/followed/players?user_id=${currentUserId}`
          );
          const data = await res.json();
          if (!data.success || !data.result || data.result.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7">目前尚未追蹤任何球員</td></tr>`;
            return;
          }
          data.result.forEach((p) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${p.player_id}</td>
                <td>${p.name}</td>
                <td>${p.number ?? ""}</td>
                <td>${p.team_name ?? ""}</td>
                <td>${p.follow_time}</td>
                <td><button class="follow-btn" onclick="showPlayerRecentMatches(${
                  p.player_id
                })">查看</button></td>
                <td><button class="follow-btn" onclick="unfollowPlayer(${
                  p.player_id
                })">取消追蹤</button></td>
            `;
            tbody.appendChild(tr);
          });
        } catch (err) {
          console.error(err);
          tbody.innerHTML = `<tr><td colspan="7">系統錯誤：${err}</td></tr>`;
        }
      }

      async function unfollowPlayer(playerId) {
        try {
          const res = await fetch(`${BASE_URL}/unfollow/player`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              player_id: playerId,
              user_id: currentUserId,
            }),
          });
          const data = await res.json();
          alert(
            data.message || (data.success ? "已取消追蹤球員" : "取消追蹤失敗")
          );
          if (data.success) loadFollowedPlayers();
        } catch (err) {
          console.error(err);
          alert("取消追蹤失敗，請稍後再試");
        }
      }

      // ======================== 球隊 ========================
      async function searchTeams() {
        const name = document.getElementById("team-search-input").value.trim();
        const tbody = document.getElementById("search-teams-body");
        tbody.innerHTML = "";
        if (!name) {
          tbody.innerHTML = `<tr><td colspan="5">請輸入球隊名稱</td></tr>`;
          return;
        }

        try {
          const res = await fetch(`${BASE_URL}/follow/search_teams`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name }),
          });
          const data = await res.json();
          if (!data.success || !data.result || data.result.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5">查無資料</td></tr>`;
            return;
          }
          data.result.forEach((t) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${t.team_id}</td>
                <td>${t.team_name}</td>
                <td>${t.manager_name}</td>
                <td>${t.league_name}</td>
                <td><button class="follow-btn" onclick="followTeam(${t.team_id})">追蹤</button></td>
            `;
            tbody.appendChild(tr);
          });
        } catch (err) {
          console.error(err);
          tbody.innerHTML = `<tr><td colspan="5">系統錯誤：${err}</td></tr>`;
        }
      }

      async function followTeam(teamId) {
        try {
          const res = await fetch(`${BASE_URL}/follow/team`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ team_id: teamId, user_id: currentUserId }),
          });
          const data = await res.json();
          alert(data.message || (data.success ? "成功追蹤球隊" : "追蹤失敗"));
          if (data.success) loadFollowedTeams();
        } catch (err) {
          console.error(err);
          alert("追蹤失敗，請稍後再試");
        }
      }

      async function loadFollowedTeams() {
        const tbody = document.getElementById("followed-teams-body");
        tbody.innerHTML = "";
        try {
          const res = await fetch(
            `${BASE_URL}/followed/teams?user_id=${currentUserId}`
          );
          const data = await res.json();
          if (!data.success || !data.result || data.result.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6">目前尚未追蹤任何球隊</td></tr>`;
            return;
          }
          data.result.forEach((t) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${t.team_id}</td>
                <td>${t.team_name}</td>
                <td>${t.manager_name}</td>
                <td>${t.follow_time}</td>
                <td><button class="follow-btn" onclick="showTeamRecentMatches(${t.team_id})">查看</button></td>
                <td><button class="follow-btn" onclick="unfollowTeam(${t.team_id})">取消追蹤</button></td>
            `;
            tbody.appendChild(tr);
          });
        } catch (err) {
          console.error(err);
          tbody.innerHTML = `<tr><td colspan="6">系統錯誤：${err}</td></tr>`;
        }
      }

      async function unfollowTeam(teamId) {
        try {
          const res = await fetch(`${BASE_URL}/unfollow/team`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ team_id: teamId, user_id: currentUserId }),
          });
          const data = await res.json();
          alert(
            data.message || (data.success ? "已取消追蹤球隊" : "取消追蹤失敗")
          );
          if (data.success) loadFollowedTeams();
        } catch (err) {
          console.error(err);
          alert("取消追蹤失敗，請稍後再試");
        }
      }

      // ======================== 最近比賽 ========================
      async function showPlayerRecentMatches(playerId) {
        const tbody = document.getElementById("player-recent-body");
        tbody.innerHTML = `<tr><td colspan="6">載入中...</td></tr>`;
        try {
          const res = await fetch(
            `${BASE_URL}/follow/player/${playerId}/recent_matches`
          );
          const data = await res.json();
          if (!data.success || !data.result || data.result.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6">查無最近比賽紀錄</td></tr>`;
            return;
          }
          tbody.innerHTML = "";
          data.result.forEach((m) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
        <td>${m.match_id}</td>
        <td>${m.date}</td>
        <td>${m.location}</td>
        <td>${m.home_team_name}</td>
        <td>${m.away_team_name}</td>
        <td>${m.home_score} : ${m.away_score}</td>
    `;
            tbody.appendChild(tr);
          });
        } catch (err) {
          console.error(err);
          tbody.innerHTML = `<tr><td colspan="6">系統錯誤：${err}</td></tr>`;
        }
      }

      async function showTeamRecentMatches(teamId) {
        const tbody = document.getElementById("team-recent-body");
        tbody.innerHTML = `<tr><td colspan="6">載入中...</td></tr>`;
        try {
          const res = await fetch(
            `${BASE_URL}/follow/team/${teamId}/recent_matches`
          );
          const data = await res.json();
          if (!data.success || !data.result || data.result.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6">查無最近比賽紀錄</td></tr>`;
            return;
          }
          tbody.innerHTML = "";
          data.result.forEach((m) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
        <td>${m.match_id}</td>
        <td>${m.date}</td>
        <td>${m.location}</td>
        <td>${m.home_team_name}</td>
        <td>${m.away_team_name}</td>
        <td>${m.home_score} : ${m.away_score}</td>
    `;
            tbody.appendChild(tr);
          });
        } catch (err) {
          console.error(err);
          tbody.innerHTML = `<tr><td colspan="6">系統錯誤：${err}</td></tr>`;
        }
      }

      // 頁面初始載入球員分頁
      showTab("player");
    </script>
</body>
</html>
