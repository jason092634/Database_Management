<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>管理員控制台</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      .tab-buttons {
        margin-bottom: 20px;
      }
      .tab-buttons button {
        margin-right: 10px;
        padding: 10px 20px;
        cursor: pointer;
      }
      .tab-content {
        display: none;
        padding: 20px;
        border: 1px solid #ddd;
      }
      .tab-content.active {
        display: block;
      }
      .form-container {
        display: flex;
        gap: 40px;
      }
      .form-box {
        flex: 1;
        border: 1px solid #ccc;
        padding: 15px;
        border-radius: 5px;
      }
      input,
      select {
        display: block;
        margin-bottom: 10px;
        padding: 5px;
        width: 100%;
      }
      label {
        margin-top: 10px;
        display: block;
      }
      button.submit-btn {
        margin-top: 10px;
        padding: 8px 16px;
        cursor: pointer;
      }
      h3 {
        margin-top: 0;
      }
      .sub-tab-content {
        display: none;
        padding: 10px 0;
      }

      .sub-tab-content.active {
        display: block;
      }

      .sub-tab-buttons button {
        margin-right: 10px;
        padding: 6px 12px;
        cursor: pointer;
      }
      #batting-table input {
        width: 60px;
        padding: 2px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <h1>管理員控制台</h1>

    <div class="tab-buttons">
      <button onclick="showTab('team')">球隊管理</button>
      <button onclick="showTab('player')">球員管理</button>
      <button onclick="showTab('umpire')">裁判管理</button>
      <button onclick="showTab('match')">比賽管理</button>
      <button onclick="showTab('match_umpire')">比賽裁判管理</button>
      <button onclick="showTab('match_player')">比賽球員管理</button>
      <button onclick="showTab('batting_record')">球員打擊數據管理</button>
      <button onclick="showTab('pitching_record')">球員投球數據管理</button>
      <button onclick="showTab('fielding_record')">球員守備數據管理</button>
      <button onclick="location.href='dashboard.html'">回主畫面</button>
    </div>

    <!-- 球隊管理 -->
    <div id="team" class="tab-content active">
      <h2>球隊管理</h2>
      <div class="form-container">
        <!-- 新增球隊 -->
        <div class="form-box">
          <h3>新增球隊</h3>
          <form id="add-team-form">
            <label>球隊名稱<span style="color: red">*</span></label>
            <input name="team_name" required />

            <label>經理名稱<span style="color: red">*</span></label>
            <input name="manager_name" />

            <label>球隊狀態<span style="color: red">*</span></label>
            <select name="team_status">
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
            </select>

            <label>所屬聯盟<span style="color: red">*</span></label>
            <select name="league_id" id="league-select" required>
              <option value="">請選擇聯盟</option>
            </select>

            <button type="submit" class="submit-btn">新增</button>
          </form>
        </div>

        <!-- 修改球隊 -->
        <div class="form-box">
          <h3>修改球隊</h3>

          <!-- 下拉選球隊 -->
          <label>選擇球隊</label>
          <select id="team-select" required>
            <option value="">請選擇球隊</option>
          </select>

          <form id="edit-team-form">
            <label>球隊名稱</label>
            <input name="team_name" id="team_name" />

            <label>經理名稱</label>
            <input name="manager_name" id="manager_name" />

            <label>狀態</label>
            <select name="team_status" id="team_status">
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
            </select>

            <label>所屬聯盟</label>
            <select name="league_id" id="league_id">
              <option value="">無</option>
            </select>

            <button type="submit" class="submit-btn">修改</button>
          </form>
        </div>
      </div>
    </div>

    <!-- 球員管理 -->
    <div id="player" class="tab-content">
      <h2>球員管理</h2>
      <div class="form-container">
        <!-- 新增球員 -->
        <div class="form-box">
          <h3>新增球員</h3>
          <form id="add-player-form">
            <label>球員姓名<span style="color: red">*</span></label>
            <input name="player_name" required />

            <label>所屬球隊<span style="color: red">*</span></label>
            <select name="team_id" id="player-team-select" required>
              <option value="">請選擇球隊</option>
            </select>

            <label>背號<span style="color: red">*</span></label>
            <input name="number" />

            <label>球員狀態<span style="color: red">*</span></label>
            <select name="status">
              <option value="Active">Active</option>
              <option value="Retired">Retired</option>
            </select>

            <button type="submit" class="submit-btn">新增</button>
          </form>
        </div>

        <!-- 修改球員 -->
        <div class="form-box">
          <h3>修改球員</h3>

          <!-- 選擇球隊 -->
          <label>選擇球隊</label>
          <select id="edit-player-team-select">
            <option value="">請選擇球隊</option>
          </select>

          <!-- 選擇球員 -->
          <label>選擇球員</label>
          <select id="edit-player-select">
            <option value="">請先選球隊</option>
          </select>

          <form id="edit-player-form">
            <label>球員姓名</label>
            <input name="player_name" id="edit-player-name" />

            <label>所屬球隊</label>
            <select name="team_id" id="edit-player-team">
              <option value="">請選擇球隊</option>
            </select>

            <label>背號</label>
            <input name="number" id="edit-player-number" />

            <label>球員狀態</label>
            <select name="status" id="edit-player-status">
              <option value="Active">Active</option>
              <option value="Retired">Retired</option>
            </select>

            <button type="submit" class="submit-btn">修改</button>
          </form>
        </div>
      </div>
    </div>

    <!-- 裁判管理 -->
    <div id="umpire" class="tab-content">
      <h2>裁判管理</h2>
      <div class="form-container">
        <div class="form-box">
          <h3>新增裁判</h3>
          <form id="add-umpire-form">
            <label>裁判姓名<span style="color: red">*</span></label>
            <input name="umpire_name" required />
            <label>裁判狀態<span style="color: red">*</span></label>
            <select name="status">
              <option value="Active">Active</option>
              <option value="Retired">Retired</option>
            </select>
            <button type="submit" class="submit-btn">新增</button>
          </form>
        </div>

        <div class="form-box">
          <h3>修改裁判</h3>

          <!-- 選擇裁判 -->
          <label>選擇裁判</label>
          <select id="edit-umpire-select">
            <option value="">請選擇裁判</option>
          </select>

          <form id="edit-umpire-form">
            <label>裁判姓名</label>
            <input name="umpire_name" id="edit-umpire-name" />

            <label>裁判狀態</label>
            <select name="status" id="edit-umpire-status">
              <option value="Active">Active</option>
              <option value="Retired">Retired</option>
            </select>

            <button type="submit" class="submit-btn">修改</button>
          </form>
        </div>
      </div>
    </div>

    <!-- 比賽管理 -->
    <div id="match" class="tab-content">
      <h2>比賽管理</h2>
      <div class="form-container">
        <!-- 新增比賽 -->
        <div class="form-box">
          <h3>新增比賽</h3>
          <form id="add-match-form">
            <label>比賽日期<span style="color: red">*</span></label>
            <input type="date" name="date" required />

            <label>主隊<span style="color: red">*</span></label>
            <select id="home-team-select" required>
              <option value="">請選擇主隊</option>
            </select>

            <label>客隊<span style="color: red">*</span></label>
            <select id="away-team-select" required>
              <option value="">請選擇客隊</option>
            </select>

            <label>比賽狀態<span style="color: red">*</span></label>
            <select name="status" required>
              <option value="scheduled">scheduled</option>
              <option value="completed">completed</option>
              <option value="postponed">postponed</option>
            </select>

            <label>比賽場地<span style="color: red">*</span></label>
            <input name="location" required />

            <label>開始時間<span style="color: red">*</span></label>
            <input type="time" name="start_time" required />

            <label>主隊分數</label>
            <input type="number" name="home_score" />

            <label>客隊分數</label>
            <input type="number" name="away_score" />

            <label>天氣</label>
            <input name="weather" />

            <label>溫度</label>
            <input type="number" step="0.1" name="temperature" />

            <label>觀眾人數</label>
            <input type="number" name="attendance" />

            <button type="submit" class="submit-btn">新增</button>
          </form>
        </div>

        <!-- 修改比賽 -->
        <div class="form-box">
          <h3>修改比賽</h3>

          <!-- 選擇日期 -->
          <label>選擇日期</label>
          <input type="date" id="edit-match-datepicker" />

          <!-- 選擇比賽 -->
          <label>選擇比賽</label>
          <select id="edit-match-select">
            <option value="">請先選擇日期</option>
          </select>

          <form id="edit-match-form">
            <label>比賽日期</label>
            <input type="date" id="edit-match-date" />

            <label>主隊</label>
            <select id="edit-home-team-select"></select>

            <label>客隊</label>
            <select id="edit-away-team-select"></select>

            <label>比賽狀態</label>
            <select id="edit-status">
              <option value="scheduled">scheduled</option>
              <option value="completed">completed</option>
              <option value="postponed">postponed</option>
            </select>

            <label>比賽場地</label>
            <input id="edit-location" />

            <label>開始時間</label>
            <input type="time" id="edit-start-time" />

            <label>主隊分數</label>
            <input type="number" id="edit-home-score" />

            <label>客隊分數</label>
            <input type="number" id="edit-away-score" />

            <label>天氣</label>
            <input id="edit-weather" />

            <label>溫度</label>
            <input type="number" step="0.1" id="edit-temperature" />

            <label>觀眾人數</label>
            <input type="number" id="edit-attendance" />

            <button type="submit" class="submit-btn">修改</button>
          </form>
        </div>
      </div>
    </div>

    <!-- 比賽裁判管理 -->
    <div id="match_umpire" class="tab-content">
      <h2>比賽裁判管理</h2>

      <div class="form-container">
        <!-- 新增比賽裁判 -->
        <div class="form-box">
          <h3>新增比賽裁判</h3>

          <!-- 選擇日期 -->
          <label>選擇日期<span style="color: red">*</span></label>
          <input type="date" id="umpire-date" required />

          <!-- 選擇比賽 -->
          <label>選擇比賽<span style="color: red">*</span></label>
          <select id="umpire-match-select" required>
            <option value="">請先選擇日期</option>
          </select>

          <hr />

          <h4>選擇裁判（可留白）</h4>

          <label>本壘（Home Plate）</label>
          <select id="umpire-home-plate">
            <option value="">無</option>
          </select>

          <label>一壘（First Base）</label>
          <select id="umpire-first-base">
            <option value="">無</option>
          </select>

          <label>二壘（Second Base）</label>
          <select id="umpire-second-base">
            <option value="">無</option>
          </select>

          <label>三壘（Third Base）</label>
          <select id="umpire-third-base">
            <option value="">無</option>
          </select>

          <label>左外野（Left Field）</label>
          <select id="umpire-left-field">
            <option value="">無</option>
          </select>

          <label>右外野（Right Field）</label>
          <select id="umpire-right-field">
            <option value="">無</option>
          </select>

          <button id="submit-umpire" class="submit-btn">新增裁判名單</button>
        </div>

        <!-- 修改比賽裁判 -->
        <div class="form-box">
          <h3>修改比賽裁判</h3>

          <!-- 選擇日期 -->
          <label>選擇日期<span style="color: red">*</span></label>
          <input type="date" id="edit-umpire-date" required />

          <!-- 選擇比賽 -->
          <label>選擇比賽<span style="color: red">*</span></label>
          <select id="edit-umpire-match-select" required>
            <option value="">請先選擇日期</option>
          </select>

          <hr />

          <h4>裁判（可修改）</h4>

          <label>本壘（Home Plate）</label>
          <select id="edit-umpire-home-plate">
            <option value="">無</option>
          </select>

          <label>一壘（First Base）</label>
          <select id="edit-umpire-first-base">
            <option value="">無</option>
          </select>

          <label>二壘（Second Base）</label>
          <select id="edit-umpire-second-base">
            <option value="">無</option>
          </select>

          <label>三壘（Third Base）</label>
          <select id="edit-umpire-third-base">
            <option value="">無</option>
          </select>

          <label>左外野（Left Field）</label>
          <select id="edit-umpire-left-field">
            <option value="">無</option>
          </select>

          <label>右外野（Right Field）</label>
          <select id="edit-umpire-right-field">
            <option value="">無</option>
          </select>

          <button id="update-umpire" class="submit-btn">更新裁判名單</button>
        </div>
      </div>
    </div>

    <!-- 比賽球員管理 -->
    <div id="match_player" class="tab-content">
      <h2>比賽球員出賽名單管理</h2>

      <!-- 新增/修改子 Tab 按鈕 -->
      <div class="sub-tab-buttons" style="margin-bottom: 20px">
        <button onclick="showSubTab('add-match-player')">新增出賽名單</button>
        <button onclick="showSubTab('edit-match-player')">修改出賽名單</button>
      </div>

      <!-- 新增出賽名單 -->
      <div id="add-match-player" class="sub-tab-content active">
        <div>
          <label>日期：</label>
          <input type="date" id="player-date" />
        </div>
        <div>
          <label>比賽：</label>
          <select id="player-match-select">
            <option value="">請選擇比賽</option>
          </select>
        </div>

        <div class="team-lineup-container" style="display: flex; gap: 50px">
          <!-- 主場 -->
          <div class="team-lineup" id="home-lineup" style="flex: 1">
            <h3>主場球隊先發打序</h3>
            <div class="starting-lineup" id="home-starting"></div>
            <h4>先發投手</h4>
            <select id="home-sp">
              <option value="">請選擇投手</option>
            </select>
            <h4>候補球員</h4>
            <div class="bench" id="home-bench"></div>
            <button class="add-bench" data-team="home">新增候補</button>
          </div>

          <!-- 客場 -->
          <div class="team-lineup" id="away-lineup" style="flex: 1">
            <h3>客場球隊先發打序</h3>
            <div class="starting-lineup" id="away-starting"></div>
            <h4>先發投手</h4>
            <select id="away-sp">
              <option value="">請選擇投手</option>
            </select>
            <h4>候補球員</h4>
            <div class="bench" id="away-bench"></div>
            <button class="add-bench" data-team="away">新增候補</button>
          </div>
        </div>

        <button id="submit-match-player">新增出賽名單</button>
      </div>

      <!-- 修改出賽名單 -->
      <div id="edit-match-player" class="sub-tab-content">
        <div>
          <label>日期：</label>
          <input type="date" id="edit-player-date" />
        </div>
        <div>
          <label>比賽：</label>
          <select id="edit-player-match-select">
            <option value="">請選擇比賽</option>
          </select>
        </div>

        <div class="team-lineup-container" style="display: flex; gap: 50px">
          <!-- 主場 -->
          <div class="team-lineup" id="edit-home-lineup" style="flex: 1">
            <h3>主場球隊先發打序</h3>
            <div class="starting-lineup" id="edit-home-starting"></div>
            <h4>先發投手</h4>
            <select id="edit-home-sp"></select>
            <h4>候補球員</h4>
            <div class="bench" id="edit-home-bench"></div>
            <button class="add-bench" data-team="edit-home">新增候補</button>
          </div>

          <!-- 客場 -->
          <div class="team-lineup" id="edit-away-lineup" style="flex: 1">
            <h3>客場球隊先發打序</h3>
            <div class="starting-lineup" id="edit-away-starting"></div>
            <h4>先發投手</h4>
            <select id="edit-away-sp"></select>
            <h4>候補球員</h4>
            <div class="bench" id="edit-away-bench"></div>
            <button class="add-bench" data-team="edit-away">新增候補</button>
          </div>
        </div>

        <button id="update-match-player">修改出賽名單</button>
      </div>
    </div>

    <!-- 球員打擊數據表格 -->
    <div id="batting_record" class="tab-content">
      <h2>球員打擊數據管理</h2>

      <!-- 選擇日期 -->
      <div>
        <label>日期：</label>
        <input type="date" id="batting-date" />
      </div>

      <!-- 選擇比賽 -->
      <div>
        <label>比賽：</label>
        <select id="batting-match-select">
          <option value="">請先選擇日期</option>
        </select>
      </div>

      <!-- 球員打擊數據表格 -->
      <div style="margin-top: 20px; overflow-x: auto">
        <table
          id="batting-table"
          border="1"
          cellpadding="5"
          cellspacing="0"
          style="border-collapse: collapse; width: 100%"
        >
          <thead>
            <tr>
              <th>球員姓名</th>
              <th>打席數</th>
              <th>打數</th>
              <th>安打</th>
              <th>二壘打</th>
              <th>三壘打</th>
              <th>全壘打</th>
              <th>三振</th>
              <th>保送</th>
              <th>觸身球</th>
              <th>犧牲飛球</th>
              <th>雙殺打</th>
              <th>三殺打</th>
              <th>打點</th>
              <th>得分</th>
              <th>盜壘</th>
              <th>盜壘失敗</th>
            </tr>
          </thead>
          <tbody id="batting-body">
            <!-- JS 會根據 match_player 填充球員行，每個欄位都是 input -->
          </tbody>
        </table>
      </div>

      <button
        id="save-batting-record"
        style="margin-top: 15px; padding: 8px 16px"
      >
        儲存打擊數據
      </button>
    </div>

    <!-- 投球數據 Tab -->
    <div id="pitching_record" class="tab-content">
      <h2>球員投球數據管理</h2>

      <div>
        <label>日期：</label>
        <input type="date" id="pitching-date" />
      </div>

      <div>
        <label>比賽：</label>
        <select id="pitching-match-select">
          <option value="">請先選擇日期</option>
        </select>
      </div>

      <div style="margin-top: 20px; overflow-x: auto">
        <table
          id="pitching-table"
          border="1"
          cellpadding="5"
          cellspacing="0"
          style="border-collapse: collapse; width: 100%"
        >
          <thead>
            <tr>
              <th>球員姓名</th>
              <th>投球角色</th>
              <th>投球結果</th>
              <th>局數</th>
              <th>球數</th>
              <th>面對打者</th>
              <th>三振</th>
              <th>保送</th>
              <th>觸身球</th>
              <th>被安打</th>
              <th>一壘安打</th>
              <th>二壘安打</th>
              <th>三壘安打</th>
              <th>全壘打</th>
              <th>失分</th>
              <th>責失分</th>
              <th>飛球出局</th>
              <th>滾地球出局</th>
              <th>平飛球出局</th>
              <th>失盜壘</th>
              <th>暴投</th>
              <th>犯規投球</th>
              <th>備註</th>
            </tr>
          </thead>
          <tbody id="pitching-body"></tbody>
        </table>
      </div>

      <button
        id="save-pitching-record"
        style="margin-top: 15px; padding: 8px 16px"
      >
        儲存投球數據
      </button>
    </div>

    <!-- 守備數據 Tab -->
    <div id="fielding_record" class="tab-content">
      <h2>球員守備數據管理</h2>

      <div>
        <label>日期：</label>
        <input type="date" id="fielding-date" />
      </div>

      <div>
        <label>比賽：</label>
        <select id="fielding-match-select">
          <option value="">請先選擇日期</option>
        </select>
      </div>

      <div style="margin-top: 20px; overflow-x: auto">
        <table
          id="fielding-table"
          border="1"
          cellpadding="5"
          cellspacing="0"
          style="border-collapse: collapse; width: 100%"
        >
          <thead>
            <tr>
              <th>球員姓名</th>
              <th>守備機會</th>
              <th>刺殺 Putouts</th>
              <th>助殺 Assists</th>
              <th>失誤 Errors</th>
              <th>備註</th>
            </tr>
          </thead>
          <tbody id="fielding-body"></tbody>
        </table>
      </div>

      <button
        id="save-fielding-record"
        style="margin-top: 15px; padding: 8px 16px"
      >
        儲存守備數據
      </button>
    </div>

    <script>
      function showTab(tabId) {
        document
          .querySelectorAll(".tab-content")
          .forEach((tab) => tab.classList.remove("active"));
        document.getElementById(tabId).classList.add("active");
      }

      function showSubTab(tabId) {
        document.querySelectorAll(".sub-tab-content").forEach((el) => {
          el.classList.remove("active");
        });
        document.getElementById(tabId).classList.add("active");
      }

      document
        .getElementById("add-team-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const payload = {
            team_name: formData.get("team_name"),
            manager_name: formData.get("manager_name"),
            team_status: formData.get("team_status"),
            league_id: formData.get("league_id"),
          };
          try {
            const res = await fetch("/admin/team/add", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            const result = await res.json();
            if (result.success) {
              alert("新增球隊成功");
              e.target.reset();
            } else {
              alert("新增球隊失敗: " + result.error);
            }
          } catch (err) {
            alert("新增球隊發生錯誤");
            console.error(err);
          }
        });

      async function loadTeams() {
        const res = await fetch("/admin/teams");
        const json = await res.json();

        if (!json.success) {
          alert("無法載入球隊列表：" + json.error);
          return;
        }

        const teams = json.teams;
        const select = document.getElementById("team-select");

        teams.forEach((t) => {
          const op = document.createElement("option");
          op.value = t.team_id;

          // 顯示用
          op.textContent = `${t.team_name}（ID: ${t.team_id}）`;

          // 資料用（更可靠）
          op.dataset.teamname = t.team_name;
          op.dataset.manager = t.manager_name;
          op.dataset.status = t.team_status;
          op.dataset.league = t.league_id;

          select.appendChild(op);
        });
      }

      async function loadLeagues() {
        try {
          const res = await fetch("/admin/leagues");
          const data = await res.json();

          if (!data.success) {
            console.error("載入聯盟失敗：", data.error);
            return;
          }

          // 新增球隊用的 select
          const addSelect = document.getElementById("league-select");
          // 修改球隊用的 select
          const editSelect = document.getElementById("league_id");

          data.leagues.forEach((l) => {
            // 新增球隊選單
            if (addSelect) {
              const opt = document.createElement("option");
              opt.value = l.league_id;
              opt.textContent = l.league_name;
              addSelect.appendChild(opt);
            }

            // 修改球隊選單
            if (editSelect) {
              const opt2 = document.createElement("option");
              opt2.value = l.league_id;
              opt2.textContent = l.league_name;
              editSelect.appendChild(opt2);
            }
          });
        } catch (err) {
          console.error("載入聯盟失敗", err);
        }
      }

      document
        .getElementById("team-select")
        .addEventListener("change", function () {
          const selected = this.options[this.selectedIndex];

          document.getElementById("team_name").value =
            selected.dataset.teamname || "";
          document.getElementById("manager_name").value =
            selected.dataset.manager || "";
          document.getElementById("team_status").value =
            selected.dataset.status || "Active";

          document.getElementById("league_id").value = selected.dataset.league
            ? selected.dataset.league
            : "";
        });

      document
        .getElementById("edit-team-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const team_id = document.getElementById("team-select").value;
          if (!team_id) {
            alert("請先選擇球隊");
            return;
          }

          const data = {
            team_id,
            team_name: document.getElementById("team_name").value,
            manager_name: document.getElementById("manager_name").value,
            team_status: document.getElementById("team_status").value,
            league_id: document.getElementById("league_id").value,
          };

          const res = await fetch("/admin/team/edit", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });

          const result = await res.json();
          if (result.success) {
            alert(result.message || "修改成功！");

            // 取得目前選中的球隊 ID
            const currentTeamID = document.getElementById("team-select").value;

            // 先清空下拉選單再重新載入球隊列表
            const teamSelect = document.getElementById("team-select");
            teamSelect.innerHTML = '<option value="">請選擇球隊</option>';
            await loadTeams();

            // 自動選回剛剛修改的球隊
            const option = document.querySelector(
              `#team-select option[value="${currentTeamID}"]`
            );
            if (option) option.selected = true;
          } else {
            alert(result.error || "修改失敗");
          }
        });

      async function loadPlayerTeams() {
        try {
          const res = await fetch("/admin/teams");
          const data = await res.json();

          if (!data.success) {
            console.error("載入球隊失敗：", data.error);
            return;
          }

          const select = document.getElementById("player-team-select");
          data.teams.forEach((t) => {
            const option = document.createElement("option");
            option.value = t.team_id;
            option.textContent = t.team_name;
            select.appendChild(option);
          });
        } catch (err) {
          console.error("載入球隊失敗", err);
        }
      }

      document
        .getElementById("add-player-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = new FormData(e.target);
          const payload = {
            player_name: formData.get("player_name"),
            team_id: formData.get("team_id"),
            number: formData.get("number"),
            status: formData.get("status"),
          };

          try {
            const res = await fetch("/admin/player/add", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            const result = await res.json();

            if (result.success) {
              alert("新增球員成功");
              e.target.reset();
            } else {
              alert("新增球員失敗: " + result.error);
            }
          } catch (err) {
            console.error(err);
            alert("新增球員發生錯誤");
          }
        });

      async function loadEditPlayerTeams() {
        try {
          const res = await fetch("/admin/teams");
          const data = await res.json();

          if (!data.success) {
            console.error("載入球隊失敗：", data.error);
            return;
          }

          const teamSelect = document.getElementById("edit-player-team-select");
          const formTeamSelect = document.getElementById("edit-player-team"); // form 裡的 select
          teamSelect.innerHTML = '<option value="">請選擇球隊</option>';
          formTeamSelect.innerHTML = '<option value="">請選擇球隊</option>';

          data.teams.forEach((t) => {
            // 下拉選球隊
            const op1 = document.createElement("option");
            op1.value = t.team_id;
            op1.textContent = t.team_name;
            teamSelect.appendChild(op1);

            const op2 = document.createElement("option");
            op2.value = t.team_id;
            op2.textContent = t.team_name;
            formTeamSelect.appendChild(op2);
          });
        } catch (err) {
          console.error("載入球隊失敗", err);
        }
      }

      document
        .getElementById("edit-player-team-select")
        .addEventListener("change", async function () {
          const teamId = this.value;
          const playerSelect = document.getElementById("edit-player-select");
          playerSelect.innerHTML = '<option value="">載入中...</option>';

          if (!teamId) {
            playerSelect.innerHTML = '<option value="">請先選球隊</option>';
            return;
          }

          try {
            const res = await fetch(`/admin/players?team_id=${teamId}`);
            const data = await res.json();

            if (!data.success) {
              console.error("載入球員失敗：", data.error);
              playerSelect.innerHTML = '<option value="">載入球員失敗</option>';
              return;
            }

            playerSelect.innerHTML = '<option value="">請選擇球員</option>';
            data.players.forEach((p) => {
              const op = document.createElement("option");
              op.value = p.player_id;
              op.textContent = `${p.player_name}（背號: ${p.number || ""}）`;
              op.dataset.name = p.player_name;
              op.dataset.number = p.number;
              op.dataset.status = p.status;
              op.dataset.team = p.team_id;
              playerSelect.appendChild(op);
            });

            // 同步「所屬球隊」下拉選單
            const editPlayerTeam = document.getElementById("edit-player-team");
            editPlayerTeam.value = teamId;
          } catch (err) {
            console.error(err);
            playerSelect.innerHTML = '<option value="">載入球員失敗</option>';
          }
        });

      document
        .getElementById("edit-player-select")
        .addEventListener("change", function () {
          const selected = this.options[this.selectedIndex];
          if (!selected.value) return;

          document.getElementById("edit-player-name").value =
            selected.dataset.name || "";
          document.getElementById("edit-player-number").value =
            selected.dataset.number || "";
          document.getElementById("edit-player-status").value =
            selected.dataset.status || "Active";
          document.getElementById("edit-player-team").value =
            selected.dataset.team || "";
        });

      document
        .getElementById("edit-player-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const playerSelect = document.getElementById("edit-player-select");
          const playerId = playerSelect.value;
          if (!playerId) {
            alert("請先選擇球員");
            return;
          }

          const data = {
            player_id: playerId,
            player_name: document.getElementById("edit-player-name").value,
            number: document.getElementById("edit-player-number").value,
            status: document.getElementById("edit-player-status").value,
            team_id: document.getElementById("edit-player-team").value,
          };

          try {
            const res = await fetch("/admin/player/edit", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
            const result = await res.json();

            if (result.success) {
              alert("球員修改成功！");

              // 記住目前選中的球員 ID
              const currentPlayerId = playerId;
              const currentTeamId = document.getElementById(
                "edit-player-team-select"
              ).value;

              if (currentTeamId) {
                const playerSelect =
                  document.getElementById("edit-player-select");
                playerSelect.innerHTML = '<option value="">載入中...</option>';

                // 重新載入球員
                const res2 = await fetch(
                  `/admin/players?team_id=${currentTeamId}`
                );
                const data2 = await res2.json();

                if (data2.success) {
                  playerSelect.innerHTML =
                    '<option value="">請選擇球員</option>';
                  data2.players.forEach((p) => {
                    const op = document.createElement("option");
                    op.value = p.player_id;
                    op.textContent = `${p.player_name}（背號: ${
                      p.number || ""
                    }）`;
                    op.dataset.name = p.player_name;
                    op.dataset.number = p.number;
                    op.dataset.status = p.status;
                    op.dataset.team = p.team_id;
                    playerSelect.appendChild(op);
                  });

                  // 自動選回剛剛修改的球員
                  const option = playerSelect.querySelector(
                    `option[value="${currentPlayerId}"]`
                  );
                  if (option) {
                    option.selected = true;
                    // 觸發 change 事件自動填入表單
                    option.dispatchEvent(new Event("change"));
                  }
                } else {
                  playerSelect.innerHTML =
                    '<option value="">載入球員失敗</option>';
                }
              }
            } else {
              alert(result.error || "修改失敗");
            }
          } catch (err) {
            console.error(err);
            alert("修改球員發生錯誤");
          }
        });

      // 新增裁判
      document
        .getElementById("add-umpire-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = new FormData(e.target);
          const payload = {
            name: formData.get("umpire_name"),
            status: formData.get("status"),
          };

          try {
            const res = await fetch("/admin/umpire/add", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            const result = await res.json();

            if (result.success) {
              alert("新增裁判成功！");
              e.target.reset();
            } else {
              alert("新增裁判失敗: " + result.error);
            }
          } catch (err) {
            console.error(err);
            alert("新增裁判發生錯誤");
          }
        });

      // 載入裁判清單
      async function loadUmpires() {
        try {
          const res = await fetch("/admin/umpires"); // 後端要提供 GET /admin/umpires API
          const data = await res.json();
          if (!data.success) {
            console.error("載入裁判失敗：", data.error);
            return;
          }

          const select = document.getElementById("edit-umpire-select");
          select.innerHTML = '<option value="">請選擇裁判</option>';

          data.umpires.forEach((u) => {
            const op = document.createElement("option");
            op.value = u.umpire_id;
            op.textContent = u.name;
            op.dataset.name = u.name;
            op.dataset.status = u.status;
            select.appendChild(op);
          });
        } catch (err) {
          console.error("載入裁判失敗", err);
        }
      }

      // 選擇裁判 → 填入表單
      document
        .getElementById("edit-umpire-select")
        .addEventListener("change", function () {
          const selected = this.options[this.selectedIndex];
          if (!selected.value) return;

          document.getElementById("edit-umpire-name").value =
            selected.dataset.name || "";
          document.getElementById("edit-umpire-status").value =
            selected.dataset.status || "Active";
        });

      // 修改裁判
      document
        .getElementById("edit-umpire-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const umpireSelect = document.getElementById("edit-umpire-select");
          const umpireId = umpireSelect.value;
          if (!umpireId) {
            alert("請先選擇裁判");
            return;
          }

          const data = {
            umpire_id: umpireId,
            name: document.getElementById("edit-umpire-name").value,
            status: document.getElementById("edit-umpire-status").value,
          };

          try {
            const res = await fetch("/admin/umpire/edit", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
            const result = await res.json();
            if (result.success) {
              alert("裁判修改成功！");

              // 重新載入裁判列表，但保持選中狀態
              const currentUmpireId = umpireId;
              await loadUmpires();

              // 選中剛剛修改的裁判
              const option = document.querySelector(
                `#edit-umpire-select option[value="${currentUmpireId}"]`
              );
              if (option) {
                option.selected = true;
                // 觸發 change 事件自動填入表單
                option.dispatchEvent(new Event("change"));
              }
            } else {
              alert("修改失敗：" + result.error);
            }
          } catch (err) {
            console.error(err);
            alert("修改裁判發生錯誤");
          }
        });

      async function loadTeamsForMatch() {
        try {
          const res = await fetch("/admin/teams");
          const data = await res.json();
          if (!data.success) return;

          const homeSelect = document.getElementById("home-team-select");
          const awaySelect = document.getElementById("away-team-select");

          // 清空選單並加上預設
          homeSelect.innerHTML = '<option value="">請選擇主隊</option>';
          awaySelect.innerHTML = '<option value="">請選擇客隊</option>';

          data.teams.forEach((team) => {
            const option = `<option value="${team.team_id}">${team.team_name}</option>`;
            homeSelect.insertAdjacentHTML("beforeend", option);
            awaySelect.insertAdjacentHTML("beforeend", option);
          });
        } catch (err) {
          console.error(err);
          alert("載入球隊清單失敗");
        }
      }

      document
        .getElementById("add-match-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData(e.target);
          const payload = {
            date: formData.get("date"),
            home_team_id: document.getElementById("home-team-select").value,
            away_team_id: document.getElementById("away-team-select").value,
            status: formData.get("status"),
            location: formData.get("location"),
            start_time: formData.get("start_time"),
            home_score: formData.get("home_score")
              ? parseInt(formData.get("home_score"))
              : 0,
            away_score: formData.get("away_score")
              ? parseInt(formData.get("away_score"))
              : 0,
            weather: formData.get("weather"),
            temperature: formData.get("temperature")
              ? parseFloat(formData.get("temperature"))
              : null,
            attendance: formData.get("attendance")
              ? parseInt(formData.get("attendance"))
              : null,
          };

          // 驗證必填欄位
          if (
            !payload.date ||
            !payload.home_team_id ||
            !payload.away_team_id ||
            !payload.status ||
            !payload.location ||
            !payload.start_time
          ) {
            alert("日期、主隊、客隊、比賽狀態、比賽場地、開始時間為必填");
            return;
          }

          if (payload.home_team_id === payload.away_team_id) {
            alert("主隊與客隊不能相同");
            return;
          }

          try {
            const res = await fetch("/admin/match/add", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            const result = await res.json();
            if (result.success) {
              alert("新增比賽成功！");
              e.target.reset();
            } else {
              alert("新增比賽失敗：" + result.error);
            }
          } catch (err) {
            console.error(err);
            alert("新增比賽發生錯誤");
          }
        });

      async function loadTeamsForEditMatch() {
        try {
          const res = await fetch("/admin/teams");
          const result = await res.json();
          if (!result.success) throw new Error(result.error);

          const homeSelect = document.getElementById("edit-home-team-select");
          const awaySelect = document.getElementById("edit-away-team-select");

          homeSelect.innerHTML = '<option value="">請選擇主隊</option>';
          awaySelect.innerHTML = '<option value="">請選擇客隊</option>';

          result.teams.forEach((team) => {
            const option1 = document.createElement("option");
            option1.value = team.team_id;
            option1.text = team.team_name;
            homeSelect.add(option1);

            const option2 = document.createElement("option");
            option2.value = team.team_id;
            option2.text = team.team_name;
            awaySelect.add(option2);
          });
        } catch (err) {
          console.error(err);
          alert("載入球隊失敗：" + err.message);
        }
      }

      // 選擇日期時，載入該日期比賽
      document
        .getElementById("edit-match-datepicker")
        .addEventListener("change", async function () {
          const date = this.value;
          if (!date) return;

          try {
            const res = await fetch(`/admin/matches?date=${date}`);
            const result = await res.json();
            const matchSelect = document.getElementById("edit-match-select");
            matchSelect.length = 1; // 保留第一個 option

            if (result.success) {
              result.matches.forEach((match) => {
                const option = document.createElement("option");
                option.value = match.match_id;
                option.text = `${match.home_team_name} vs ${
                  match.away_team_name
                } (${match.start_time || "--:--"})`;
                option.dataset.info = JSON.stringify(match);
                matchSelect.add(option);
              });
            } else {
              alert("載入比賽失敗：" + result.error);
            }
          } catch (err) {
            console.error(err);
            alert("載入比賽發生錯誤");
          }
        });

      // 選擇比賽後帶入表單
      document
        .getElementById("edit-match-select")
        .addEventListener("change", function () {
          const selected = this.selectedOptions[0];
          if (!selected || !selected.dataset.info) return;

          const match = JSON.parse(selected.dataset.info);

          document.getElementById("edit-match-date").value = match.date;
          document.getElementById("edit-home-team-select").value =
            match.home_team_id;
          document.getElementById("edit-away-team-select").value =
            match.away_team_id;
          document.getElementById("edit-status").value = match.status;
          document.getElementById("edit-location").value = match.location || "";
          document.getElementById("edit-start-time").value =
            match.start_time || "";
          document.getElementById("edit-home-score").value =
            match.home_score || 0;
          document.getElementById("edit-away-score").value =
            match.away_score || 0;
          document.getElementById("edit-weather").value = match.weather || "";
          document.getElementById("edit-temperature").value =
            match.temperature || "";
          document.getElementById("edit-attendance").value =
            match.attendance || "";
        });

      // 提交修改
      document
        .getElementById("edit-match-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const matchSelect = document.getElementById("edit-match-select");
          const matchId = matchSelect.value;
          if (!matchId) {
            alert("請先選擇比賽");
            return;
          }

          const data = {
            match_id: matchId,
            date: document.getElementById("edit-match-date").value,
            home_team_id: document.getElementById("edit-home-team-select")
              .value,
            away_team_id: document.getElementById("edit-away-team-select")
              .value,
            status: document.getElementById("edit-status").value,
            location: document.getElementById("edit-location").value,
            start_time: document.getElementById("edit-start-time").value,
            home_score:
              parseInt(document.getElementById("edit-home-score").value) || 0,
            away_score:
              parseInt(document.getElementById("edit-away-score").value) || 0,
            weather: document.getElementById("edit-weather").value,
            temperature:
              parseFloat(document.getElementById("edit-temperature").value) ||
              null,
            attendance:
              parseInt(document.getElementById("edit-attendance").value) ||
              null,
          };

          if (data.home_team_id === data.away_team_id) {
            alert("主隊與客隊不能相同！");
            return;
          }

          try {
            const res = await fetch("/admin/match/edit", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
            const result = await res.json();
            if (result.success) {
              alert("比賽修改成功！");
            } else {
              alert("修改失敗：" + result.error);
            }
          } catch (err) {
            console.error(err);
            alert("修改比賽發生錯誤");
          }
        });

      document.addEventListener("DOMContentLoaded", () => {
        const dateInput = document.getElementById("umpire-date");
        const matchSelect = document.getElementById("umpire-match-select");

        const umpireSelectors = {
          "Home Plate": document.getElementById("umpire-home-plate"),
          "First Base": document.getElementById("umpire-first-base"),
          "Second Base": document.getElementById("umpire-second-base"),
          "Third Base": document.getElementById("umpire-third-base"),
          "Left Field": document.getElementById("umpire-left-field"),
          "Right Field": document.getElementById("umpire-right-field"),
        };

        // 載入所有裁判
        async function loadAllUmpires() {
          try {
            const res = await fetch("/admin/umpires");
            const data = await res.json();
            if (!data.success) return;

            Object.values(umpireSelectors).forEach((sel) => {
              sel.innerHTML = '<option value="">無</option>';
              data.umpires.forEach((u) => {
                const opt = document.createElement("option");
                opt.value = u.umpire_id;
                opt.textContent = u.name;
                sel.appendChild(opt);
              });
            });
          } catch (err) {
            console.error("載入裁判失敗", err);
          }
        }
        loadAllUmpires();

        // 選日期 → 抓比賽清單
        dateInput.addEventListener("change", async () => {
          const date = dateInput.value;
          matchSelect.innerHTML = '<option value="">請選擇比賽</option>';
          if (!date) return;

          try {
            const res = await fetch(`/admin/matches?date=${date}`);
            const data = await res.json();
            if (!data.success) return;

            data.matches.forEach((m) => {
              const opt = document.createElement("option");
              opt.value = m.match_id;
              opt.textContent = `${m.start_time || ""} ${m.home_team_name} vs ${
                m.away_team_name
              }`;
              matchSelect.appendChild(opt);
            });
          } catch (err) {
            console.error(err);
          }
        });

        // 選比賽 → 載入現有裁判
        matchSelect.addEventListener("change", async () => {
          const matchId = matchSelect.value;
          if (!matchId) return;

          try {
            const res = await fetch(`/admin/match/umpires?match_id=${matchId}`);
            const data = await res.json();
            if (!data.success) return;

            // 清空選單
            Object.values(umpireSelectors).forEach((sel) => (sel.value = ""));

            data.umpires.forEach((u) => {
              if (umpireSelectors[u.role]) {
                umpireSelectors[u.role].value = u.umpire_id;
              }
            });
          } catch (err) {
            console.error(err);
          }
        });

        // 新增 / 更新比賽裁判
        document
          .getElementById("submit-umpire")
          .addEventListener("click", async () => {
            const matchId = matchSelect.value;
            if (!matchId) {
              alert("請先選擇比賽");
              return;
            }

            const umpires = Object.entries(umpireSelectors).map(
              ([role, sel]) => ({
                role,
                umpire_id: sel.value || null,
              })
            );

            try {
              const res = await fetch("/admin/match/umpire/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ match_id: matchId, umpires }),
              });
              const data = await res.json();
              if (data.success) {
                alert("裁判名單已更新");
              } else {
                alert("更新失敗：" + data.error);
              }
            } catch (err) {
              console.error(err);
              alert("更新裁判發生錯誤");
            }
          });
      });

      document.addEventListener("DOMContentLoaded", () => {
        // ======== 修改比賽裁判 =========
        const editDateInput = document.getElementById("edit-umpire-date");
        const editMatchSelect = document.getElementById(
          "edit-umpire-match-select"
        );

        const editUmpireSelectors = {
          "Home Plate": document.getElementById("edit-umpire-home-plate"),
          "First Base": document.getElementById("edit-umpire-first-base"),
          "Second Base": document.getElementById("edit-umpire-second-base"),
          "Third Base": document.getElementById("edit-umpire-third-base"),
          "Left Field": document.getElementById("edit-umpire-left-field"),
          "Right Field": document.getElementById("edit-umpire-right-field"),
        };

        // 載入所有裁判
        async function loadAllEditUmpires() {
          try {
            const res = await fetch("/admin/umpires");
            const data = await res.json();
            if (!data.success) return;

            Object.values(editUmpireSelectors).forEach((sel) => {
              sel.innerHTML = '<option value="">無</option>';
              data.umpires.forEach((u) => {
                const opt = document.createElement("option");
                opt.value = u.umpire_id;
                opt.textContent = u.name;
                sel.appendChild(opt);
              });
            });
          } catch (err) {
            console.error("載入裁判失敗", err);
          }
        }
        loadAllEditUmpires();

        // 選日期 → 載入比賽
        editDateInput.addEventListener("change", async () => {
          const date = editDateInput.value;
          editMatchSelect.innerHTML = '<option value="">請選擇比賽</option>';
          if (!date) return;

          try {
            const res = await fetch(`/admin/matches?date=${date}`);
            const data = await res.json();
            if (!data.success) return;

            data.matches.forEach((m) => {
              const opt = document.createElement("option");
              opt.value = m.match_id;
              opt.textContent = `${m.start_time || ""} ${m.home_team_name} vs ${
                m.away_team_name
              }`;
              editMatchSelect.appendChild(opt);
            });
          } catch (err) {
            console.error(err);
          }
        });

        // 選比賽 → 載入現有裁判
        editMatchSelect.addEventListener("change", async () => {
          const matchId = editMatchSelect.value;
          if (!matchId) return;

          try {
            const res = await fetch(`/admin/match/umpires?match_id=${matchId}`);
            const data = await res.json();
            if (!data.success) return;

            // 將選單先清空
            Object.values(editUmpireSelectors).forEach(
              (sel) => (sel.value = "")
            );

            data.umpires.forEach((u) => {
              if (editUmpireSelectors[u.role]) {
                editUmpireSelectors[u.role].value = u.umpire_id;
              }
            });
          } catch (err) {
            console.error(err);
          }
        });

        // 修改比賽裁判 → POST
        document
          .getElementById("update-umpire")
          .addEventListener("click", async () => {
            const matchId = editMatchSelect.value;
            if (!matchId) {
              alert("請先選擇比賽");
              return;
            }

            const umpires = Object.entries(editUmpireSelectors).map(
              ([role, sel]) => ({
                role,
                umpire_id: sel.value || null,
              })
            );

            try {
              const res = await fetch("/admin/match/umpire/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ match_id: matchId, umpires }),
              });
              const data = await res.json();
              if (data.success) {
                alert("裁判名單已更新");
              } else {
                alert("更新失敗：" + data.error);
              }
            } catch (err) {
              console.error(err);
              alert("更新裁判發生錯誤");
            }
          });
      });

      document.addEventListener("DOMContentLoaded", () => {
        const dateInput = document.getElementById("player-date");
        const matchSelect = document.getElementById("player-match-select");

        let homePlayers = [];
        let awayPlayers = [];

        const homeStarting = document.getElementById("home-starting");
        const awayStarting = document.getElementById("away-starting");
        const homeBench = document.getElementById("home-bench");
        const awayBench = document.getElementById("away-bench");
        const homeSP = document.getElementById("home-sp");
        const awaySP = document.getElementById("away-sp");

        // 選日期 → 載入比賽
        dateInput.addEventListener("change", async () => {
          const date = dateInput.value;
          matchSelect.innerHTML = '<option value="">請選擇比賽</option>';
          if (!date) return;
          try {
            const res = await fetch(`/admin/matches?date=${date}`);
            const data = await res.json();
            if (!data.success) return;
            data.matches.forEach((m) => {
              const opt = document.createElement("option");
              opt.value = m.match_id;
              opt.textContent = `${m.start_time || ""} ${m.home_team_name} vs ${
                m.away_team_name
              }`;
              matchSelect.appendChild(opt);
            });
          } catch (err) {
            console.error(err);
          }
        });

        // 選比賽 → 載入球員
        matchSelect.addEventListener("change", async () => {
          const matchId = matchSelect.value;
          if (!matchId) return;

          try {
            const res = await fetch(`/admin/match/players?match_id=${matchId}`);
            const data = await res.json();
            if (!data.success) return;

            homePlayers = data.home_players;
            awayPlayers = data.away_players;

            renderStarting(homeStarting, homePlayers);
            renderStarting(awayStarting, awayPlayers);
            renderSP(homeSP, homePlayers);
            renderSP(awaySP, awayPlayers);
            renderBench(homeBench);
            renderBench(awayBench);
          } catch (err) {
            console.error(err);
          }
        });

        // 先發打序
        function renderStarting(container, players) {
          container.innerHTML = "";
          for (let i = 1; i <= 9; i++) {
            const div = document.createElement("div");
            div.classList.add("starting-player");

            const selectPlayer = document.createElement("select");
            selectPlayer.innerHTML =
              `<option value="">請選擇球員</option>` +
              players
                .map((p) => `<option value="${p.player_id}">${p.name}</option>`)
                .join("");

            const selectPos = document.createElement("select");
            selectPos.innerHTML = `
        <option value="">守備位置</option>
        <option value="P">P</option>
        <option value="C">C</option>
        <option value="1B">1B</option>
        <option value="2B">2B</option>
        <option value="3B">3B</option>
        <option value="SS">SS</option>
        <option value="LF">LF</option>
        <option value="CF">CF</option>
        <option value="RF">RF</option>
        <option value="DH">DH</option>
      `;

            div.innerHTML = `<span>${i}棒: </span>`;
            div.appendChild(selectPlayer);
            div.appendChild(selectPos);
            container.appendChild(div);
          }
        }

        // 先發投手
        function renderSP(container, players) {
          container.innerHTML =
            `<option value="">請選擇投手</option>` +
            players
              .map((p) => `<option value="${p.player_id}">${p.name}</option>`)
              .join("");
        }

        // 候補欄位（不含守備位置）
        function renderBench(container, count = 5) {
          container.innerHTML = "";
          for (let i = 0; i < count; i++) {
            addBenchRow(container);
          }
        }

        function addBenchRow(container) {
          const div = document.createElement("div");
          div.classList.add("bench-player");
          const team = container.id.startsWith("home")
            ? homePlayers
            : awayPlayers;

          div.innerHTML = `
      <select>
        <option value="">請選擇球員</option>
        ${team
          .map((p) => `<option value="${p.player_id}">${p.name}</option>`)
          .join("")}
      </select>
      <button class="remove-bench">X</button>
    `;
          container.appendChild(div);
          div
            .querySelector(".remove-bench")
            .addEventListener("click", () => div.remove());
        }

        // 新增候補按鈕
        document.querySelectorAll(".add-bench").forEach((btn) => {
          btn.addEventListener("click", () => {
            const team = btn.dataset.team === "home" ? homeBench : awayBench;
            addBenchRow(team);
          });
        });

        // 提交出賽名單
        document
          .getElementById("submit-match-player")
          .addEventListener("click", async () => {
            const matchId = matchSelect.value;
            if (!matchId) {
              alert("請先選擇比賽");
              return;
            }

            // 收集先發球員
            const gatherStarting = (container) => {
              return Array.from(
                container.querySelectorAll(".starting-player")
              ).map((div, i) => ({
                player_id: div.querySelector("select").value,
                position: div.querySelectorAll("select")[1].value || null,
                batting_order: i + 1,
                is_starting: true,
              }));
            };

            // 收集投手
            const gatherSP = (select) => {
              const val = select.value;
              return val
                ? [
                    {
                      player_id: val,
                      position: "P",
                      batting_order: null,
                      is_starting: true,
                    },
                  ]
                : [];
            };

            // 收集候補
            const gatherBench = (container) => {
              return Array.from(container.querySelectorAll(".bench-player"))
                .map((div) => ({
                  player_id: div.querySelector("select").value,
                  position: null,
                  batting_order: null,
                  is_starting: false,
                }))
                .filter((p) => p.player_id);
            };

            // 檢查先發完整性
            const checkStartingComplete = (starting, sp) => {
              const missingPlayer = starting.some((p) => !p.player_id);
              const missingSP = sp.length === 0;
              return !missingPlayer && !missingSP;
            };

            const homeStartingPlayers = gatherStarting(homeStarting);
            const awayStartingPlayers = gatherStarting(awayStarting);
            const homeSPPlayer = gatherSP(homeSP);
            const awaySPPlayer = gatherSP(awaySP);

            if (!checkStartingComplete(homeStartingPlayers, homeSPPlayer)) {
              alert("主隊先發球員或投手尚未完整填寫！");
              return;
            }

            if (!checkStartingComplete(awayStartingPlayers, awaySPPlayer)) {
              alert("客隊先發球員或投手尚未完整填寫！");
              return;
            }

            const players = [
              ...homeStartingPlayers,
              ...homeSPPlayer,
              ...gatherBench(homeBench),
              ...awayStartingPlayers,
              ...awaySPPlayer,
              ...gatherBench(awayBench),
            ];

            try {
              const res = await fetch("/admin/match/player/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ match_id: matchId, players }),
              });
              const data = await res.json();
              if (data.success) alert("球員出賽名單已更新");
              else alert("更新失敗：" + data.error);
            } catch (err) {
              console.error(err);
              alert("更新出賽名單發生錯誤");
            }
          });
      });

      document.addEventListener("DOMContentLoaded", () => {
        const editDateInput = document.getElementById("edit-player-date");
        const editMatchSelect = document.getElementById(
          "edit-player-match-select"
        );

        const editHomeStarting = document.getElementById("edit-home-starting");
        const editAwayStarting = document.getElementById("edit-away-starting");
        const editHomeBench = document.getElementById("edit-home-bench");
        const editAwayBench = document.getElementById("edit-away-bench");
        const editHomeSP = document.getElementById("edit-home-sp");
        const editAwaySP = document.getElementById("edit-away-sp");

        let editHomePlayers = [];
        let editAwayPlayers = [];

        // 選日期 → 載入比賽
        editDateInput.addEventListener("change", async () => {
          const date = editDateInput.value;
          editMatchSelect.innerHTML = '<option value="">請選擇比賽</option>';
          if (!date) return;

          try {
            const res = await fetch(`/admin/matches?date=${date}`);
            const data = await res.json();
            if (!data.success) return;

            data.matches.forEach((m) => {
              const opt = document.createElement("option");
              opt.value = m.match_id;
              opt.textContent = `${m.start_time || ""} ${m.home_team_name} vs ${
                m.away_team_name
              }`;
              editMatchSelect.appendChild(opt);
            });
          } catch (err) {
            console.error(err);
          }
        });

        // 選比賽 → 載入現有出賽名單
        editMatchSelect.addEventListener("change", async () => {
          const matchId = editMatchSelect.value;
          if (!matchId) return;

          try {
            const res = await fetch(`/admin/match/players?match_id=${matchId}`);
            const data = await res.json();
            if (!data.success) return;

            editHomePlayers = data.home_players;
            editAwayPlayers = data.away_players;

            // 分類 match_players
            const homeStarting = data.match_players.filter(
              (p) =>
                p.is_starting &&
                p.position !== "P" &&
                editHomePlayers.some((h) => h.player_id === p.player_id)
            );
            const awayStarting = data.match_players.filter(
              (p) =>
                p.is_starting &&
                p.position !== "P" &&
                editAwayPlayers.some((a) => a.player_id === p.player_id)
            );
            const homeSP = data.match_players.filter(
              (p) =>
                p.is_starting &&
                p.position === "P" &&
                editHomePlayers.some((h) => h.player_id === p.player_id)
            );
            const awaySP = data.match_players.filter(
              (p) =>
                p.is_starting &&
                p.position === "P" &&
                editAwayPlayers.some((a) => a.player_id === p.player_id)
            );
            const homeBench = data.match_players.filter(
              (p) =>
                !p.is_starting &&
                editHomePlayers.some((h) => h.player_id === p.player_id)
            );
            const awayBench = data.match_players.filter(
              (p) =>
                !p.is_starting &&
                editAwayPlayers.some((a) => a.player_id === p.player_id)
            );

            renderStarting(editHomeStarting, editHomePlayers, homeStarting);
            renderStarting(editAwayStarting, editAwayPlayers, awayStarting);
            renderSP(editHomeSP, editHomePlayers, homeSP);
            renderSP(editAwaySP, editAwayPlayers, awaySP);
            renderBench(editHomeBench, homeBench);
            renderBench(editAwayBench, awayBench);
          } catch (err) {
            console.error(err);
          }
        });

        // 先發球員
        function renderStarting(container, players, startingPlayers = []) {
          container.innerHTML = "";
          for (let i = 1; i <= 9; i++) {
            const div = document.createElement("div");
            div.classList.add("starting-player");

            const selectPlayer = document.createElement("select");
            selectPlayer.innerHTML =
              `<option value="">請選擇球員</option>` +
              players
                .map(
                  (p) =>
                    `<option value="${p.player_id}" ${
                      startingPlayers[i - 1] &&
                      startingPlayers[i - 1].player_id === p.player_id
                        ? "selected"
                        : ""
                    }>${p.name}</option>`
                )
                .join("");

            const selectPos = document.createElement("select");
            const positions = [
              "P",
              "C",
              "1B",
              "2B",
              "3B",
              "SS",
              "LF",
              "CF",
              "RF",
              "DH",
            ];
            selectPos.innerHTML =
              `<option value="">守備位置</option>` +
              positions
                .map(
                  (pos) =>
                    `<option value="${pos}" ${
                      startingPlayers[i - 1] &&
                      startingPlayers[i - 1].position === pos
                        ? "selected"
                        : ""
                    }>${pos}</option>`
                )
                .join("");

            div.innerHTML = `<span>${i}棒: </span>`;
            div.appendChild(selectPlayer);
            div.appendChild(selectPos);
            container.appendChild(div);
          }
        }

        // 先發投手
        function renderSP(container, players, spPlayer = []) {
          container.innerHTML =
            `<option value="">請選擇投手</option>` +
            players
              .map(
                (p) =>
                  `<option value="${p.player_id}" ${
                    spPlayer.length && spPlayer[0].player_id === p.player_id
                      ? "selected"
                      : ""
                  }>${p.name}</option>`
              )
              .join("");
        }

        // 候補
        function renderBench(container, benchPlayers = [], count = 5) {
          container.innerHTML = "";
          benchPlayers.forEach((p) => addBenchRow(container, p.player_id));
          for (let i = benchPlayers.length; i < count; i++) {
            addBenchRow(container);
          }
        }

        function addBenchRow(container, playerId = "") {
          const div = document.createElement("div");
          div.classList.add("bench-player");
          const team = container.id.startsWith("edit-home")
            ? editHomePlayers
            : editAwayPlayers;

          div.innerHTML = `
      <select>
        <option value="">請選擇球員</option>
        ${team
          .map(
            (p) =>
              `<option value="${p.player_id}" ${
                p.player_id === playerId ? "selected" : ""
              }>${p.name}</option>`
          )
          .join("")}
      </select>
      <button class="remove-bench">X</button>
    `;
          container.appendChild(div);
          div
            .querySelector(".remove-bench")
            .addEventListener("click", () => div.remove());
        }

        // 新增候補按鈕
        document.querySelectorAll(".edit-add-bench").forEach((btn) => {
          btn.addEventListener("click", () => {
            const team =
              btn.dataset.team === "home" ? editHomeBench : editAwayBench;
            addBenchRow(team);
          });
        });

        // 收集球員資料
        function gatherStarting(container) {
          return Array.from(container.querySelectorAll(".starting-player")).map(
            (div, i) => ({
              player_id: div.querySelectorAll("select")[0].value,
              position: div.querySelectorAll("select")[1].value || null,
              batting_order: i + 1,
              is_starting: true,
            })
          );
        }

        function gatherSP(select) {
          const val = select.value;
          return val
            ? [
                {
                  player_id: val,
                  position: "P",
                  batting_order: null,
                  is_starting: true,
                },
              ]
            : [];
        }

        function gatherBench(container) {
          return Array.from(container.querySelectorAll(".bench-player"))
            .map((div) => ({
              player_id: div.querySelector("select").value,
              position: null,
              batting_order: null,
              is_starting: false,
            }))
            .filter((p) => p.player_id);
        }

        // 提交修改
        document
          .getElementById("update-match-player")
          .addEventListener("click", async () => {
            const matchId = editMatchSelect.value;
            if (!matchId) {
              alert("請先選擇比賽");
              return;
            }

            const homeStartingPlayers = gatherStarting(editHomeStarting);
            const awayStartingPlayers = gatherStarting(editAwayStarting);
            const homeSPPlayer = gatherSP(editHomeSP);
            const awaySPPlayer = gatherSP(editAwaySP);

            if (
              homeStartingPlayers.some((p) => !p.player_id) ||
              homeSPPlayer.length === 0
            ) {
              alert("主隊先發球員或投手尚未完整填寫！");
              return;
            }
            if (
              awayStartingPlayers.some((p) => !p.player_id) ||
              awaySPPlayer.length === 0
            ) {
              alert("客隊先發球員或投手尚未完整填寫！");
              return;
            }

            const players = [
              ...homeStartingPlayers,
              ...homeSPPlayer,
              ...gatherBench(editHomeBench),
              ...awayStartingPlayers,
              ...awaySPPlayer,
              ...gatherBench(editAwayBench),
            ];

            try {
              const res = await fetch("/admin/match/player/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ match_id: matchId, players }),
              });
              const data = await res.json();
              if (data.success) alert("球員出賽名單已更新");
              else alert("更新失敗：" + data.error);
            } catch (err) {
              console.error(err);
              alert("更新出賽名單發生錯誤");
            }
          });
      });

      // 打擊數據
      document.addEventListener("DOMContentLoaded", () => {
        const dateInput = document.getElementById("batting-date");
        const matchSelect = document.getElementById("batting-match-select");
        const battingBody = document.getElementById("batting-body");
        const saveBtn = document.getElementById("save-batting-record");

        // 選日期 → 載入比賽
        dateInput.addEventListener("change", async () => {
          const date = dateInput.value;
          matchSelect.innerHTML = '<option value="">請選擇比賽</option>';
          battingBody.innerHTML = "";
          if (!date) return;

          try {
            const res = await fetch(`/admin/matches?date=${date}`);
            const data = await res.json();
            if (!data.success) return;

            data.matches.forEach((m) => {
              const opt = document.createElement("option");
              opt.value = m.match_id;
              opt.textContent = `${m.start_time || ""} ${m.home_team_name} vs ${
                m.away_team_name
              }`;
              matchSelect.appendChild(opt);
            });
          } catch (err) {
            console.error(err);
            alert("取得比賽列表失敗");
          }
        });

        // 選比賽 → 載入球員打擊紀錄
        matchSelect.addEventListener("change", async () => {
          const matchId = matchSelect.value;
          if (!matchId) {
            battingBody.innerHTML = "";
            return;
          }

          try {
            const res = await fetch(`/admin/match/batting?match_id=${matchId}`);
            const data = await res.json();
            if (!data.success) return;

            battingBody.innerHTML = ""; // 清空表格

            // ===== 主場球員 =====
            if (data.home_players?.length) {
              const homeTitle = document.createElement("tr");
              homeTitle.innerHTML = `<td colspan="17" style="font-weight:bold; background:#f0f0f0; text-align:center;">主場球員</td>`;
              battingBody.appendChild(homeTitle);

              data.home_players.forEach((p) => {
                const tr = document.createElement("tr");
                tr.dataset.playerId = p.player_id;
                tr.dataset.recordId = p.batting_record?.record_id || ""; // ⚡ 使用 record_id
                tr.innerHTML = generatePlayerRowHTML(p);
                battingBody.appendChild(tr);
              });
            }

            // ===== 客場球員 =====
            if (data.away_players?.length) {
              const awayTitle = document.createElement("tr");
              awayTitle.innerHTML = `<td colspan="17" style="font-weight:bold; background:#e0f7ff; text-align:center;">客場球員</td>`;
              battingBody.appendChild(awayTitle);

              data.away_players.forEach((p) => {
                const tr = document.createElement("tr");
                tr.dataset.playerId = p.player_id;
                tr.dataset.recordId = p.batting_record?.record_id || ""; // ⚡ 使用 record_id
                tr.innerHTML = generatePlayerRowHTML(p);
                battingBody.appendChild(tr);
              });
            }
          } catch (err) {
            console.error(err);
            alert("取得球員打擊資料失敗");
          }
        });

        // 儲存打擊數據
        saveBtn.addEventListener("click", async () => {
          const matchId = matchSelect.value;
          if (!matchId) return alert("請先選擇比賽");

          const records = Array.from(battingBody.querySelectorAll("tr"))
            .map((tr) => {
              const inputs = tr.querySelectorAll("input");
              if (!inputs.length) return null; // 跳過分隔列
              const id = parseInt(tr.dataset.recordId); // ⚡ 使用 record_id
              if (isNaN(id)) return null;

              return {
                record_id: id, // ⚡ 用 record_id 更新/新增
                plate_appearance: parseInt(inputs[0].value) || 0,
                at_bats: parseInt(inputs[1].value) || 0,
                hits: parseInt(inputs[2].value) || 0,
                doubles: parseInt(inputs[3].value) || 0,
                triples: parseInt(inputs[4].value) || 0,
                home_runs: parseInt(inputs[5].value) || 0,
                strikeouts: parseInt(inputs[6].value) || 0,
                walks: parseInt(inputs[7].value) || 0,
                hit_by_pitch: parseInt(inputs[8].value) || 0,
                sacrifice_flies: parseInt(inputs[9].value) || 0,
                double_play: parseInt(inputs[10].value) || 0,
                triple_play: parseInt(inputs[11].value) || 0,
                rbis: parseInt(inputs[12].value) || 0,
                runs: parseInt(inputs[13].value) || 0,
                stolen_bases: parseInt(inputs[14].value) || 0,
                caught_stealing: parseInt(inputs[15].value) || 0,
              };
            })
            .filter((r) => r !== null);

          if (records.length === 0) {
            return alert("沒有有效的打擊數據可以更新");
          }

          try {
            const res = await fetch(`/admin/match/batting/add`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ match_id: matchId, records }),
            });
            const data = await res.json();
            if (data.success) alert("打擊數據已更新");
            else alert("更新失敗：" + data.error);
          } catch (err) {
            console.error(err);
            alert("更新打擊數據發生錯誤");
          }
        });

        // 生成球員列 HTML
        function generatePlayerRowHTML(p) {
          const r = p.batting_record || {}; // ⚡ 使用 batting_record
          return `
            <td>${p.name}</td>
            <td><input type="number" value="${r.plate_appearance ?? 0}" /></td>
            <td><input type="number" value="${r.at_bats ?? 0}" /></td>
            <td><input type="number" value="${r.hits ?? 0}" /></td>
            <td><input type="number" value="${r.doubles ?? 0}" /></td>
            <td><input type="number" value="${r.triples ?? 0}" /></td>
            <td><input type="number" value="${r.home_runs ?? 0}" /></td>
            <td><input type="number" value="${r.strikeouts ?? 0}" /></td>
            <td><input type="number" value="${r.walks ?? 0}" /></td>
            <td><input type="number" value="${r.hit_by_pitch ?? 0}" /></td>
            <td><input type="number" value="${r.sacrifice_flies ?? 0}" /></td>
            <td><input type="number" value="${r.double_play ?? 0}" /></td>
            <td><input type="number" value="${r.triple_play ?? 0}" /></td>
            <td><input type="number" value="${r.rbis ?? 0}" /></td>
            <td><input type="number" value="${r.runs ?? 0}" /></td>
            <td><input type="number" value="${r.stolen_bases ?? 0}" /></td>
            <td><input type="number" value="${r.caught_stealing ?? 0}" /></td>
        `;
        }
      });

      // 投球數據
      document.addEventListener("DOMContentLoaded", () => {
        const dateInput = document.getElementById("pitching-date");
        const matchSelect = document.getElementById("pitching-match-select");
        const pitchingBody = document.getElementById("pitching-body");
        const saveBtn = document.getElementById("save-pitching-record");

        // 選日期 → 載入比賽
        dateInput.addEventListener("change", async () => {
          const date = dateInput.value;
          matchSelect.innerHTML = '<option value="">請選擇比賽</option>';
          pitchingBody.innerHTML = "";
          if (!date) return;

          try {
            const res = await fetch(`/admin/matches?date=${date}`);
            const data = await res.json();
            if (!data.success) return;

            data.matches.forEach((m) => {
              const opt = document.createElement("option");
              opt.value = m.match_id;
              opt.textContent = `${m.start_time || ""} ${m.home_team_name} vs ${
                m.away_team_name
              }`;
              matchSelect.appendChild(opt);
            });
          } catch (err) {
            console.error(err);
            alert("取得比賽列表失敗");
          }
        });

        // 選比賽 → 載入球員投球紀錄
        matchSelect.addEventListener("change", async () => {
          const matchId = matchSelect.value;
          if (!matchId) {
            pitchingBody.innerHTML = "";
            return;
          }

          try {
            const res = await fetch(
              `/admin/match/pitching?match_id=${matchId}`
            );
            const data = await res.json();
            if (!data.success) return;

            pitchingBody.innerHTML = ""; // 清空表格

            // ===== 主場球員 =====
            if (data.home_players?.length) {
              const homeTitle = document.createElement("tr");
              homeTitle.innerHTML = `<td colspan="23" style="font-weight:bold; background:#f0f0f0; text-align:center;">主場球員</td>`;
              pitchingBody.appendChild(homeTitle);

              data.home_players.forEach((p) => {
                const tr = document.createElement("tr");
                tr.dataset.playerId = p.player_id;
                tr.dataset.recordId = p.pitching_record?.record_id || "";
                tr.innerHTML = generatePlayerRowHTML(p);
                pitchingBody.appendChild(tr);
              });
            }

            // ===== 客場球員 =====
            if (data.away_players?.length) {
              const awayTitle = document.createElement("tr");
              awayTitle.innerHTML = `<td colspan="23" style="font-weight:bold; background:#e0f7ff; text-align:center;">客場球員</td>`;
              pitchingBody.appendChild(awayTitle);

              data.away_players.forEach((p) => {
                const tr = document.createElement("tr");
                tr.dataset.playerId = p.player_id;
                tr.dataset.recordId = p.pitching_record?.record_id || "";
                tr.innerHTML = generatePlayerRowHTML(p);
                pitchingBody.appendChild(tr);
              });
            }
          } catch (err) {
            console.error(err);
            alert("取得球員投球資料失敗");
          }
        });

        // 儲存投球數據
        saveBtn.addEventListener("click", async () => {
          const matchId = matchSelect.value;
          if (!matchId) return alert("請先選擇比賽");

          const records = Array.from(pitchingBody.querySelectorAll("tr"))
            .map((tr) => {
              const inputs = tr.querySelectorAll("input, select");
              if (!inputs.length) return null;

              const id = parseInt(tr.dataset.recordId);
              if (isNaN(id)) return null;

              return {
                record_id: id,
                pitching_role: inputs[0].value || null, // ⚡ 空白傳 null
                pitch_result: inputs[1].value || "",
                innings_pitched: parseFloat(inputs[2].value) || 0,
                pitches: parseInt(inputs[3].value) || 0,
                batters_faced: parseInt(inputs[4].value) || 0,
                strikeouts: parseInt(inputs[5].value) || 0,
                walks: parseInt(inputs[6].value) || 0,
                hit_batters: parseInt(inputs[7].value) || 0,
                hits_allowed: parseInt(inputs[8].value) || 0,
                singles: parseInt(inputs[9].value) || 0,
                doubles: parseInt(inputs[10].value) || 0,
                triples: parseInt(inputs[11].value) || 0,
                home_runs: parseInt(inputs[12].value) || 0,
                runs_allowed: parseInt(inputs[13].value) || 0,
                earned_runs: parseInt(inputs[14].value) || 0,
                fly_outs: parseInt(inputs[15].value) || 0,
                ground_outs: parseInt(inputs[16].value) || 0,
                line_outs: parseInt(inputs[17].value) || 0,
                stolen_bases_allowed: parseInt(inputs[18].value) || 0,
                wild_pitches: parseInt(inputs[19].value) || 0,
                balks: parseInt(inputs[20].value) || 0,
                remarks: inputs[21].value || "",
              };
            })
            .filter((r) => r !== null);

          if (records.length === 0) {
            return alert("沒有有效的投球數據可以更新");
          }

          try {
            const res = await fetch(`/admin/match/pitching/add`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ match_id: matchId, records }),
            });
            const data = await res.json();
            if (data.success) alert("投球數據已更新");
            else alert("更新失敗：" + data.error);
          } catch (err) {
            console.error(err);
            alert("更新投球數據發生錯誤");
          }
        });

        // 生成球員列 HTML
        function generatePlayerRowHTML(p) {
          const r = p.pitching_record || {};
          return `
      <td>${p.name}</td>
      <td>
        <select>
          <option value="">--</option>
          <option value="SP" ${
            r.pitching_role === "SP" ? "selected" : ""
          }>SP</option>
          <option value="RP" ${
            r.pitching_role === "RP" ? "selected" : ""
          }>RP</option>
          <option value="CL" ${
            r.pitching_role === "CL" ? "selected" : ""
          }>CL</option>
        </select>
      </td>
      <td><input type="text" value="${r.pitch_result ?? ""}" /></td>
      <td><input type="number" step="0.1" value="${
        r.innings_pitched ?? 0
      }" /></td>
      <td><input type="number" value="${r.pitches ?? 0}" /></td>
      <td><input type="number" value="${r.batters_faced ?? 0}" /></td>
      <td><input type="number" value="${r.strikeouts ?? 0}" /></td>
      <td><input type="number" value="${r.walks ?? 0}" /></td>
      <td><input type="number" value="${r.hit_batters ?? 0}" /></td>
      <td><input type="number" value="${r.hits_allowed ?? 0}" /></td>
      <td><input type="number" value="${r.singles ?? 0}" /></td>
      <td><input type="number" value="${r.doubles ?? 0}" /></td>
      <td><input type="number" value="${r.triples ?? 0}" /></td>
      <td><input type="number" value="${r.home_runs ?? 0}" /></td>
      <td><input type="number" value="${r.runs_allowed ?? 0}" /></td>
      <td><input type="number" value="${r.earned_runs ?? 0}" /></td>
      <td><input type="number" value="${r.fly_outs ?? 0}" /></td>
      <td><input type="number" value="${r.ground_outs ?? 0}" /></td>
      <td><input type="number" value="${r.line_outs ?? 0}" /></td>
      <td><input type="number" value="${r.stolen_bases_allowed ?? 0}" /></td>
      <td><input type="number" value="${r.wild_pitches ?? 0}" /></td>
      <td><input type="number" value="${r.balks ?? 0}" /></td>
      <td><input type="text" value="${r.remarks ?? ""}" /></td>
    `;
        }
      });

      // 守備數據
      document.addEventListener("DOMContentLoaded", () => {
        const dateInput = document.getElementById("fielding-date");
        const matchSelect = document.getElementById("fielding-match-select");
        const fieldingBody = document.getElementById("fielding-body");
        const saveBtn = document.getElementById("save-fielding-record");

        // 選日期 → 載入比賽
        dateInput.addEventListener("change", async () => {
          const date = dateInput.value;
          matchSelect.innerHTML = '<option value="">請選擇比賽</option>';
          fieldingBody.innerHTML = "";
          if (!date) return;

          try {
            const res = await fetch(`/admin/matches?date=${date}`);
            const data = await res.json();
            if (!data.success) return;

            data.matches.forEach((m) => {
              const opt = document.createElement("option");
              opt.value = m.match_id;
              opt.textContent = `${m.start_time || ""} ${m.home_team_name} vs ${
                m.away_team_name
              }`;
              matchSelect.appendChild(opt);
            });
          } catch (err) {
            console.error(err);
            alert("取得比賽列表失敗");
          }
        });

        // 選比賽 → 載入守備紀錄
        matchSelect.addEventListener("change", async () => {
          const matchId = matchSelect.value;
          if (!matchId) {
            fieldingBody.innerHTML = "";
            return;
          }

          try {
            const res = await fetch(
              `/admin/match/fielding?match_id=${matchId}`
            );
            const data = await res.json();
            if (!data.success) return;

            fieldingBody.innerHTML = ""; // 清空表格

            // ===== 主場球員 =====
            if (data.home_players?.length) {
              const homeTitle = document.createElement("tr");
              homeTitle.innerHTML = `<td colspan="6" style="font-weight:bold; background:#f0f0f0; text-align:center;">主場球員</td>`;
              fieldingBody.appendChild(homeTitle);

              data.home_players.forEach((p) => {
                const tr = document.createElement("tr");
                tr.dataset.recordId = p.fielding_record?.record_id || "";
                tr.innerHTML = generateRowHTML(p);
                fieldingBody.appendChild(tr);
              });
            }

            // ===== 客場球員 =====
            if (data.away_players?.length) {
              const awayTitle = document.createElement("tr");
              awayTitle.innerHTML = `<td colspan="6" style="font-weight:bold; background:#e0f7ff; text-align:center;">客場球員</td>`;
              fieldingBody.appendChild(awayTitle);

              data.away_players.forEach((p) => {
                const tr = document.createElement("tr");
                tr.dataset.recordId = p.fielding_record?.record_id || "";
                tr.innerHTML = generateRowHTML(p);
                fieldingBody.appendChild(tr);
              });
            }
          } catch (err) {
            console.error(err);
            alert("取得守備資料失敗");
          }
        });

        // 儲存守備數據
        saveBtn.addEventListener("click", async () => {
          const matchId = matchSelect.value;
          if (!matchId) return alert("請先選擇比賽");

          const records = Array.from(fieldingBody.querySelectorAll("tr"))
            .map((tr) => {
              const inputs = tr.querySelectorAll("input");
              if (!inputs.length) return null;

              const id = parseInt(tr.dataset.recordId);
              if (isNaN(id)) return null;

              return {
                record_id: id,
                fielding_chances: parseInt(inputs[0].value) || 0,
                putouts: parseInt(inputs[1].value) || 0,
                assists: parseInt(inputs[2].value) || 0,
                errors: parseInt(inputs[3].value) || 0,
                remarks: inputs[4].value || "",
              };
            })
            .filter((r) => r !== null);

          if (records.length === 0) return alert("沒有有效的守備數據可以更新");

          try {
            const res = await fetch(`/admin/match/fielding/add`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ match_id: matchId, records }),
            });
            const data = await res.json();
            if (data.success) alert("守備數據已更新");
            else alert("更新失敗：" + data.error);
          } catch (err) {
            console.error(err);
            alert("更新守備數據發生錯誤");
          }
        });

        // ---- 產生 HTML ----
        function generateRowHTML(p) {
          const r = p.fielding_record || {};
          return `
      <td>${p.name}</td>
      <td><input type="number" value="${r.fielding_chances ?? 0}" /></td>
      <td><input type="number" value="${r.putouts ?? 0}" /></td>
      <td><input type="number" value="${r.assists ?? 0}" /></td>
      <td><input type="number" value="${r.errors ?? 0}" /></td>
      <td><input type="text" value="${r.remarks ?? ""}" /></td>
    `;
        }
      });

      loadLeagues();
      loadTeams();
      loadPlayerTeams();
      loadEditPlayerTeams();
      loadUmpires();
      loadTeamsForMatch();
      loadTeamsForEditMatch();
    </script>
  </body>
</html>
